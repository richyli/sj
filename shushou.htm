<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–ç›¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .animate-pulse-fast { animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800 p-4 md:p-8 flex justify-center">

    <div class="max-w-3xl w-full bg-white shadow-xl rounded-xl overflow-hidden border border-slate-200 flex flex-col min-h-[850px]">
        
        <!-- Header -->
        <div class="bg-slate-900 p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center shrink-0 gap-4">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="landmark" class="h-6 w-6"></i>
                    é¦–ç›¸ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
                </h1>
                <p class="text-slate-400 text-sm mt-1" id="turn-display">ä»»æœŸ 1 å¹´ç›® / å…¨ 5 å¹´</p>
                <p class="text-slate-500 text-xs mt-1">â€»æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³çµæœã¯æ•™è‚²ç›®çš„ã®ã‚‚ã®ã§ã‚ã‚Šã€ç¾å®Ÿã®çŠ¶æ³ã‚’åæ˜ ã—ãŸã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
            
            <!-- Political Capital Display -->
            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700 w-full md:w-auto">
                <div class="text-xs text-slate-400 mb-1 flex justify-between">
                    <span>æ”¿æ²»çš„è³‡æœ¬ (HP)</span>
                    <span id="hp-text" class="font-bold text-white">8 / 8</span>
                </div>
                <div class="flex gap-1" id="hp-bar">
                    <!-- Hearts will be injected here -->
                </div>
            </div>
        </div>

        <!-- Dashboard Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6 bg-slate-50 border-b border-slate-200 shrink-0">
            <!-- Debt -->
            <div id="card-debt" class="p-4 rounded-lg border bg-white border-slate-100 cursor-pointer transition-all hover:shadow-sm hover:border-blue-200 relative ring-2 ring-offset-1 ring-blue-500 shadow-md" onclick="selectMetric('debt')">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-slate-500 uppercase">å›½å‚µæ®‹é«˜</span>
                    <i data-lucide="shield-alert" class="h-4 w-4 text-red-500"></i>
                </div>
                <div id="val-debt" class="text-3xl font-bold text-slate-800">1286å…†</div>
                <div id="sub-debt" class="text-sm text-slate-400 mt-1">å¯¾GDPæ¯” 216.1%</div>
                <div id="indicator-debt" class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-blue-500 rotate-45"></div>
            </div>

            <!-- GDP -->
            <div id="card-gdp" class="p-4 rounded-lg border bg-white border-slate-100 cursor-pointer transition-all hover:shadow-sm hover:border-blue-200 relative" onclick="selectMetric('gdp')">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-slate-500 uppercase">åç›® GDP</span>
                    <i data-lucide="japanese-yen" class="h-4 w-4 text-blue-500"></i>
                </div>
                <div id="val-gdp" class="text-3xl font-bold text-slate-800">595å…†</div>
                <div id="sub-gdp" class="text-sm text-slate-400 mt-1">çµŒæ¸ˆè¦æ¨¡</div>
                <div id="indicator-gdp" class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-blue-500 rotate-45 hidden"></div>
            </div>

            <!-- Interest Rate -->
            <div id="card-interestRate" class="p-4 rounded-lg border bg-white border-slate-100 cursor-pointer transition-all hover:shadow-sm hover:border-blue-200 relative" onclick="selectMetric('interestRate')">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-slate-500 uppercase">å›½å‚µé‡‘åˆ©</span>
                    <i data-lucide="trending-up" class="h-4 w-4 text-orange-500"></i>
                </div>
                <div id="val-interestRate" class="text-3xl font-bold text-slate-800">0.9%</div>
                <div id="sub-interestRate" class="text-sm text-slate-400 mt-1">åˆ©æ‰•ã„è² æ‹…</div>
                <div id="indicator-interestRate" class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-blue-500 rotate-45 hidden"></div>
            </div>

            <!-- Approval -->
            <div id="card-approval" class="p-4 rounded-lg border bg-white border-slate-100 cursor-pointer transition-all hover:shadow-sm hover:border-blue-200 relative" onclick="selectMetric('approval')">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-slate-500 uppercase">å†…é–£æ”¯æŒç‡</span>
                    <i data-lucide="users" class="h-4 w-4 text-green-500"></i>
                </div>
                <div id="val-approval" class="text-3xl font-bold text-slate-800">45%</div>
                <div id="sub-approval" class="text-sm text-slate-400 mt-1">æ”¿æ²»çš„åŸºç›¤</div>
                <div id="indicator-approval" class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-blue-500 rotate-45 hidden"></div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white border-b border-slate-200 p-6 shrink-0 h-56">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="activity" class="h-5 w-5 text-slate-500"></i>
                <h3 class="text-sm font-bold text-slate-500 uppercase">æ”¿æ¨©é‹å–¶ãƒ‡ãƒ¼ã‚¿æ¨ç§»</h3>
                <span id="chart-label" class="text-xs text-slate-400 ml-auto">å›½å‚µ (å…†å††)</span>
            </div>
            <div class="h-32 w-full" id="chart-container">
                <!-- SVG Chart will be injected here -->
            </div>
        </div>

        <!-- Game Area (Dynamic Content) -->
        <div id="game-area" class="p-6 flex-grow flex flex-col justify-center">
            <!-- Content will be injected by JS -->
        </div>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Data Definitions ---
        const INITIAL_STATE = {
            turn: 0,
            debt: 1286,
            gdp: 595,
            interestRate: 0.9,
            approval: 45,
            hp: 8,
            history: [],
            metricsHistory: [{ turn: 0, debt: 1286, gdp: 595, interestRate: 0.9, approval: 45 }],
            gameOver: false,
            endingType: null,
            message: ""
        };

        const SCENARIOS = [
            {
                id: 1,
                title: "ç¤¾ä¼šä¿éšœè²»ã®åº•ãªã—æ²¼",
                description: "é«˜é½¢åŒ–ã«ã‚ˆã‚ŠåŒ»ç™‚ã¨å¹´é‡‘æ”¯å‡ºãŒæ€¥å¢—ã—ã¦ã„ã¾ã™ã€‚ã“ã®è«å¤§ãªæ”¯å‡ºã‚’ã©ã†è³„ã†ã‹æ±ºæ–­ãŒå¿…è¦ã§ã™ã€‚",
                statContext: "ç¾åœ¨ã®å›½å‚µæ®‹é«˜ï¼š1286 å…†å††",
                choices: [
                    {
                        type: "å·¦æ´¾ (å¢—ç¨)",
                        text: "çµ¦ä»˜ç¶­æŒã€å¯Œè£•å±¤ãƒ»ä¼æ¥­ã¸ã®å¤§å¹…å¢—ç¨",
                        impact: "é«˜é½¢è€…ã®ç”Ÿæ´»ã¯å®ˆã‚‰ã‚Œã¾ã—ãŸãŒã€ä¼æ¥­ãŒæµ·å¤–æµå‡ºã‚’ç¤ºå”†ã—ã€æ ªä¾¡ãŒæ€¥è½ã—ã¦ã„ã¾ã™ã€‚",
                        tweet: { user: "åƒããŠçˆ¶ã•ã‚“ @salaryman_jp", content: "é‡‘æŒã¡å„ªé‡ã¯ã‚‚ã†çµ‚ã‚ã‚Šã ï¼ã§ã‚‚ä¼šç¤¾ãŒæµ·å¤–é€ƒã’ãŸã‚‰ä¿ºãŸã¡ã®ä»•äº‹ã©ã†ãªã‚‹ã®ï¼Ÿä¸å®‰... #å¯Œè£•å±¤å¢—ç¨ #ç¤¾ä¼šä¿éšœ" },
                        effect: (s) => ({ debt: s.debt - 10, approval: s.approval + 5, gdp: s.gdp - 10, history: [...s.history, "1å¹´ç›®ï¼šå¯Œè£•å±¤ã¸ã®å¢—ç¨ã§ç¤¾ä¼šä¿éšœã‚’ç¶­æŒã€‚"] })
                    },
                    {
                        type: "ä¸­é“ (å›½å‚µ)",
                        text: "èµ¤å­—å›½å‚µã‚’ç™ºè¡Œã—ã€ç¾çŠ¶ç¶­æŒ",
                        impact: "å•é¡Œã¯å…ˆé€ã‚Šã•ã‚Œã€ã²ã¨ã¾ãšå¹³ç©ãŒä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚",
                        tweet: { user: "çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹bot @eco_bot", content: "ã¾ãŸèµ¤å­—å›½å‚µç™ºè¡Œã‹ã€‚å°†æ¥ã®ãƒ„ã‚±ãŒæ€–ã„ãªã€‚å­ä¾›ãŸã¡ã«è¬ã‚ŠãŸã„æ°—åˆ†ã€‚ #å›½å‚µ #å…ˆé€ã‚Š" },
                        effect: (s) => ({ debt: s.debt + 30, approval: s.approval + 2, history: [...s.history, "1å¹´ç›®ï¼šå•é¡Œå…ˆé€ã‚Šã‚’é¸æŠã€èµ¤å­—å›½å‚µç™ºè¡Œã€‚"] })
                    },
                    {
                        type: "å³æ´¾ (å‰Šæ¸›)",
                        text: "çµ¦ä»˜ã‚’å¾¹åº•å‰Šæ¸›ã€ã€Œè‡ªåŠ©ã€ã‚’å¼·èª¿",
                        impact: "è²¡æ”¿ã¯åŠ‡çš„ã«æ”¹å–„ã—ã¾ã—ãŸãŒã€é«˜é½¢è€…ãŒè²§å›°ã«é™¥ã‚Šã€ç¤¾ä¼šä¸å®‰ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚",
                        tweet: { user: "æ€’ã‚Œã‚‹å¹´é‡‘å—çµ¦è€… @senior_voice", content: "å¹´é‡‘ã‚«ãƒƒãƒˆã¯æ­»æ´»å•é¡Œã ï¼ãšã£ã¨çœŸé¢ç›®ã«åƒã„ã¦ããŸã®ã«ã€ã“ã®ä»•æ‰“ã¡ã¯ãªã‚“ã ï¼è¨±ã›ãªã„ï¼ #å¹´é‡‘å‰Šæ¸› #æ£„æ°‘æ”¿ç­–" },
                        effect: (s) => ({ debt: s.debt - 25, approval: s.approval - 20, gdp: s.gdp + 5, history: [...s.history, "1å¹´ç›®ï¼šç¤¾ä¼šä¿éšœè²»ã®å¤§ãƒŠã‚¿ã€ç—›ã¿ã‚’ä¼´ã†æ”¹é©ã€‚"] })
                    }
                ]
            },
            {
                id: 2,
                title: "æ¶ˆè²»ç¨å¢—ç¨ã®æ±ºæ–­",
                description: "IMFã¯è²¡æ”¿å¥å…¨åŒ–ã®ãŸã‚ã«æ¶ˆè²»ç¨å¢—ç¨ã‚’å¼·ãæ¨å¥¨ã—ã¦ã„ã¾ã™ãŒã€å®¶è¨ˆã‚’ç›´æ’ƒã™ã‚‹ã“ã¨ã¯å¿…è‡³ã§ã™ã€‚",
                statContext: "å€‹äººæ¶ˆè²»ã®ä½è¿·",
                choices: [
                    {
                        type: "å·¦æ´¾ (æ¸›ç¨)",
                        text: "æ¶ˆè²»ç¨ã‚’5%ã¸æ¸›ç¨ã€å®¶è¨ˆè² æ‹…ã‚’è»½æ¸›",
                        impact: "æ¶ˆè²»ãŒçˆ†ç™ºçš„ã«å›å¾©ã—ã¾ã—ãŸãŒã€è²¡æ”¿èµ¤å­—ãŒä¸€æ°—ã«æ‹¡å¤§ã—ã¾ã—ãŸã€‚",
                        tweet: { user: "ä¸»å©¦ã®çŸ¥æµè¢‹ @mama_saver", content: "æ¸›ç¨ã‚­ã‚¿ãƒ¼ï¼ğŸ‰ ã“ã‚Œã§å°‘ã—ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§è²·ã„ç‰©ã—ã‚„ã™ããªã‚‹ã‹ã‚‚ï¼ç·ç†ã‚ã‚ŠãŒã¨ã†ï¼ #æ¶ˆè²»ç¨æ¸›ç¨ #ç”Ÿæ´»è‹¦" },
                        effect: (s) => ({ debt: s.debt + 40, gdp: s.gdp + 25, approval: s.approval + 15, interestRate: s.interestRate + 0.1, history: [...s.history, "2å¹´ç›®ï¼šå¤§èƒ†ãªæ¸›ç¨ã§æ¶ˆè²»ã‚’åˆºæ¿€ã€‚"] })
                    },
                    {
                        type: "ä¸­é“ (çµ¦ä»˜é‡‘)",
                        text: "10%ç¶­æŒã€ä¸€æ™‚çµ¦ä»˜é‡‘ã‚’æ”¯çµ¦",
                        impact: "æ ¹æœ¬çš„ãªè§£æ±ºã«ãªã‚‰ãšã€å‚µå‹™ã¯å¾®å¢—ã€çµŒæ¸ˆåŠ¹æœã‚‚é™å®šçš„ã§ã™ã€‚",
                        tweet: { user: "å†·ç¬‘ç³» @cynical_jp", content: "çµ¦ä»˜é‡‘10ä¸‡å††ï¼Ÿç„¼ã‘çŸ³ã«æ°´ã ã‚ˆã€‚é¸æŒ™å¯¾ç­–ã®ãƒãƒ©ãƒã‚­ä¹™ã€‚ #çµ¦ä»˜é‡‘ #ãƒãƒ©ãƒã‚­" },
                        effect: (s) => ({ debt: s.debt + 10, gdp: s.gdp + 5, approval: s.approval + 5, history: [...s.history, "2å¹´ç›®ï¼šçµ¦ä»˜é‡‘ã§å›½æ°‘ã®ä¸æº€ã‚’ä¸€æ™‚çš„ã«ç·©å’Œã€‚"] })
                    },
                    {
                        type: "å³æ´¾ (å¢—ç¨)",
                        text: "15%ã¸å¢—ç¨ã€è²¡æ”¿è¦å¾‹ã‚’å …æŒ",
                        impact: "è²¡æ”¿é»’å­—åŒ–ç›®æ¨™ã«ã¯è¿‘ã¥ãã¾ã—ãŸãŒã€æ¶ˆè²»ãŒå†·ãˆè¾¼ã¿ã€å°å£²åº—ã®å€’ç”£ãŒç›¸æ¬¡ã„ã§ã„ã¾ã™ã€‚",
                        tweet: { user: "å•†åº—è¡—ã®æ‚²é³´ @shutter_street", content: "å¢—ç¨ãµã–ã‘ã‚“ãªï¼ã‚‚ã†åº—ç•³ã‚€ã—ã‹ãªã„ã‚ˆã€‚ãŠå®¢ã•ã‚“å…¨ç„¶æ¥ãªã„... #æ¶ˆè²»ç¨å¢—ç¨ #è²¡å‹™çœè§£ä½“" },
                        effect: (s) => ({ debt: s.debt - 30, gdp: s.gdp - 15, approval: s.approval - 15, history: [...s.history, "2å¹´ç›®ï¼šæ‰¹åˆ¤ã‚’æã‚Œãšå¢—ç¨ã‚’æ–­è¡Œã€‚"] })
                    }
                ]
            },
            {
                id: 3,
                title: "æ—¥éŠ€ã®é‡‘åˆ©ã‚¸ãƒ¬ãƒ³ãƒ",
                description: "ã‚¤ãƒ³ãƒ•ãƒ¬ã¨å††å®‰ã®ãƒ€ãƒ–ãƒ«ãƒ‘ãƒ³ãƒã§ã™ã€‚æ—¥éŠ€ç·è£ãŒæ¬¡ã®ä¸€æ‰‹ã‚’ä»°ã„ã§ã„ã¾ã™ã€‚",
                statContext: "ç¾åœ¨ã®é‡‘åˆ©ï¼š0.9% (ä¸Šæ˜‡å‚¾å‘)",
                choices: [
                    {
                        type: "å·¦æ´¾ (ç·©å’Œ)",
                        text: "é‡‘èç·©å’Œã‚’ç¶™ç¶šã€æ”¿åºœæ”¯å‡ºã‚’æ‹¡å¤§",
                        impact: "å††ç›¸å ´ã¯170å††ã‚’çªç ´ã€ç‰©ä¾¡é«˜é¨°ãŒæ­¢ã¾ã‚Šã¾ã›ã‚“ãŒã€è¼¸å‡ºä¼æ¥­ã®åˆ©ç›Šã¯éå»æœ€é«˜ã§ã™ã€‚",
                        tweet: { user: "ç‰©ä¾¡é«˜é¨°è‹¦ã—ã„ @inflation_hell", content: "å††å®‰ãŒæ­¢ã¾ã‚‰ãªã„ï¼ã‚¬ã‚½ãƒªãƒ³é«˜ã™ãï¼ã‚¹ãƒ¼ãƒ‘ãƒ¼ã®åµã‚‚å€¤ä¸ŠãŒã‚Š...ç”Ÿæ´»ã§ããªã„ã‚ˆğŸ˜­ #å††å®‰ #ç‰©ä¾¡é«˜" },
                        effect: (s) => ({ interestRate: s.interestRate - 0.2, debt: s.debt + 20, gdp: s.gdp + 10, approval: s.approval - 10, history: [...s.history, "3å¹´ç›®ï¼šã‚¤ãƒ³ãƒ•ãƒ¬ã‚’ç„¡è¦–ã—ç·©å’Œã‚’ç¶™ç¶šã€‚"] })
                    },
                    {
                        type: "ä¸­é“ (æ¼¸é€²)",
                        text: "æ®µéšçš„ã«åˆ©ä¸Šã’ã€è»Ÿç€é™¸ã‚’ç›®æŒ‡ã™",
                        impact: "å¸‚å ´ã®åå¿œã¯å†·é™ã§ã™ãŒã€åˆ©æ‰•ã„è² æ‹…ãŒå¾ã€…ã«é‡ãã®ã—ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚",
                        tweet: { user: "ãƒã‚¤ãƒ›ãƒ¼ãƒ ãƒ‘ãƒ‘ @loan_worrier", content: "ä½å®…ãƒ­ãƒ¼ãƒ³ã®é‡‘åˆ©ãŒä¸ŠãŒã‚Šå§‹ã‚ãŸ...å¤‰å‹•é‡‘åˆ©ã§å€Ÿã‚Šã¦ã‚‹ã‹ã‚‰ãƒã‚¸ã§æ€–ã„ã€‚ #é‡‘åˆ©å¼•ãä¸Šã’ #ä½å®…ãƒ­ãƒ¼ãƒ³" },
                        effect: (s) => ({ interestRate: s.interestRate + 0.5, debt: s.debt + (s.debt * 0.01), approval: s.approval - 5, history: [...s.history, "3å¹´ç›®ï¼šæ…é‡ãªåˆ©ä¸Šã’ã§ãƒãƒ©ãƒ³ã‚¹ã‚’å›³ã‚‹ã€‚"] })
                    },
                    {
                        type: "å³æ´¾ (å¼•ç· )",
                        text: "æ€¥æ¿€ãªåˆ©ä¸Šã’ã€ã‚¤ãƒ³ãƒ•ãƒ¬ã‚’å¾¹åº•é€€æ²»",
                        impact: "ã‚¤ãƒ³ãƒ•ãƒ¬ã¯æ²ˆé™åŒ–ã—å††é«˜ã«æˆ»ã‚Šã¾ã—ãŸãŒã€å›½å‚µåˆ©æ‰•ã„è²»ãŒçˆ†ç™ºã—äºˆç®—å±æ©ŸãŒç™ºç”Ÿã€‚",
                        tweet: { user: "æ ªãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼X @market_crash", content: "é‡‘åˆ©æ€¥é¨°ã§æ ªä¾¡æš´è½ï¼ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ç™ºå‹•ï¼æ—¥æœ¬çµŒæ¸ˆçµ‚ã‚ã£ãŸãª...ğŸ“‰ #æ—¥çµŒå¹³å‡ #ãƒ–ãƒ©ãƒƒã‚¯ãƒãƒ³ãƒ‡ãƒ¼" },
                        effect: (s) => ({ interestRate: s.interestRate + 2.0, debt: s.debt + (s.debt * 0.03), gdp: s.gdp - 10, approval: s.approval - 10, history: [...s.history, "3å¹´ç›®ï¼šã‚¿ã‚«æ´¾çš„åˆ©ä¸Šã’ã‚·ãƒ§ãƒƒã‚¯ç™‚æ³•ã€‚"] })
                    }
                ]
            },
            {
                id: 4,
                title: "åœ°æ”¿å­¦ãƒªã‚¹ã‚¯ã¨é˜²è¡›è²»",
                description: "åœ°åŸŸã®ç·Šå¼µãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚åŒç›Ÿå›½ã‹ã‚‰é˜²è¡›è²»ã®å¤§å¹…å¢—é¡ã‚’æ±‚ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚",
                statContext: "é˜²è¡›äºˆç®—ã®é€¼è¿«",
                choices: [
                    {
                        type: "å·¦æ´¾ (å¹³å’Œ)",
                        text: "è»æ‹¡æ‹’å¦ã€äºˆç®—ã‚’æ°‘ç”Ÿãƒ»å¤–äº¤ã¸",
                        impact: "åŒç›Ÿå›½ã¨ã®é–¢ä¿‚ã¯ç·Šå¼µã—ã¾ã—ãŸãŒã€å›½å†…ã®ç¦ç¥‰äºˆç®—ã¯ç¢ºä¿ã•ã‚Œã¾ã—ãŸã€‚",
                        tweet: { user: "ãƒ”ãƒ¼ã‚¹ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼ @no_war_jp", content: "å¹³å’Œæ†²æ³•ã‚’å®ˆã‚ã†ï¼è»æ‹¡åå¯¾ï¼å¤–äº¤åŠªåŠ›ã§å¹³å’Œã‚’ä½œã‚‹ã¹ãã ğŸ•Šï¸ #æ†²æ³•9æ¡ #å¹³å’Œ" },
                        effect: (s) => ({ debt: s.debt - 5, approval: s.approval + 5, gdp: s.gdp + 5, history: [...s.history, "4å¹´ç›®ï¼šå¹³å’Œæ†²æ³•è·¯ç·šã‚’é¸æŠã€‚"] })
                    },
                    {
                        type: "ä¸­é“ (æŠ˜è¡·)",
                        text: "å°å¹…ãªå¢—é¡ã€å¢—ç¨ã§è³„ã†",
                        impact: "èª°ã‹ã‚‰ã‚‚æº€è¶³ã•ã‚Œã¾ã›ã‚“ãŒã€æœ€ä½é™ã®å›½é˜²ã¨è²¡æ”¿ã‚’ç¶­æŒã—ã¾ã—ãŸã€‚",
                        tweet: { user: "æ”¿æ²»ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼ @seiji_watch", content: "é˜²è¡›è²»ã®ãŸã‚ã«å¢—ç¨ï¼Ÿå¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨ã®è»¢ç”¨ã¨ã‹æ„å‘³ã‚ã‹ã‚‰ã‚“ã€‚ç´å¾—ã„ã‹ãªã„ãªã€‚ #é˜²è¡›å¢—ç¨ #å²¸ç”°æ”¿æ¨©" },
                        effect: (s) => ({ gdp: s.gdp - 5, approval: s.approval - 5, history: [...s.history, "4å¹´ç›®ï¼šå¢—ç¨ã«ã‚ˆã‚‹å°å¹…ãªè»æ‹¡ã€‚"] })
                    },
                    {
                        type: "å³æ´¾ (å¼·å…µ)",
                        text: "ã€Œé˜²è¡›å›½å‚µã€ã‚’ç™ºè¡Œã€è»è²»å€å¢—",
                        impact: "è»éœ€ç”£æ¥­ãŒæ´»æ³ã§ã™ãŒã€å›½ã®è²¡æ”¿èµ¤å­—ã¯éå»æœ€æ‚ªã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚",
                        tweet: { user: "æ†‚å›½ã®å£« @patriot_jp", content: "å›½ã‚’å®ˆã‚‹ã«ã¯é‡‘ãŒã‹ã‹ã‚‹ã€‚ãƒŸã‚µã‚¤ãƒ«è²·ã‚ãªãã‚ƒå›½ãŒæ»…ã¶ãã€‚å›½å‚µç™ºè¡Œã¯ä»•æ–¹ãªã„é¸æŠã ã€‚ #é˜²è¡›è²» #å›½é˜²" },
                        effect: (s) => ({ debt: s.debt + 50, gdp: s.gdp + 15, interestRate: s.interestRate + 0.4, approval: s.approval + 5, history: [...s.history, "4å¹´ç›®ï¼šé˜²è¡›å›½å‚µã§è»å‚™å¢—å¼·ã€‚"] })
                    }
                ]
            },
            {
                id: 5,
                title: "æœ€å¾Œã®è³­ã‘ï¼šäººå£å±æ©Ÿã¨ç§»æ°‘",
                description: "åŠ´åƒåŠ›ãŒæ¯æ¸‡ã—ã€åœ°æ–¹ãŒæ¶ˆæ»…ã®å±æ©Ÿã«ç€•ã—ã¦ã„ã¾ã™ã€‚å›½ã®äººå£æ”¿ç­–ã®æ–¹å‘æ€§ã‚’æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
                statContext: "åŠ´åƒåŠ›ä¸è¶³ï¼šæ¥µã‚ã¦æ·±åˆ»",
                choices: [
                    {
                        type: "å·¦æ´¾ (é–‹æ”¾)",
                        text: "ç§»æ°‘ã®å…¨é¢é–‹æ”¾ã€æ°¸ä½æ¨©ä»˜ä¸",
                        impact: "çµŒæ¸ˆã«å¼·åŠ›ãªæ´»åŠ›ãŒæ³¨å…¥ã•ã‚ŒGDPãŒé£›èºã—ã¾ã—ãŸãŒã€ç¤¾ä¼šãƒ»æ–‡åŒ–çš„æ‘©æ“¦ãŒæ¿€åŒ–ã—ã¦ã„ã¾ã™ã€‚",
                        tweet: { user: "åœ°å…ƒä½æ°‘ @local_voice", content: "æœ€è¿‘ã€ã‚³ãƒ³ãƒ“ãƒ‹ã‚‚å·¥å ´ã‚‚å¤–å›½äººã°ã‹ã‚Šã ã€‚è¡—ã®é›°å›²æ°—ãŒå¤‰ã‚ã£ãŸãª...æ²»å®‰å¤§ä¸ˆå¤«ã‹ãªï¼Ÿ #ç§»æ°‘æ”¿ç­– #å¤šæ–‡åŒ–å…±ç”Ÿ" },
                        effect: (s) => ({ gdp: s.gdp + 40, debt: s.debt - 15, approval: s.approval - 20, history: [...s.history, "5å¹´ç›®ï¼šé–‹å›½ã€ç§»æ°‘å›½å®¶ã¸ã®è»¢æ›ã€‚"] })
                    },
                    {
                        type: "ä¸­é“ (åˆ¶é™)",
                        text: "æŠ€èƒ½å®Ÿç¿’ç”Ÿæ‹¡å¤§ã€åœ¨ç•™æœŸé™ã‚ã‚Š",
                        impact: "å®‰ä¾¡ãªåŠ´åƒåŠ›ã¯ç¢ºä¿ã—ã¾ã—ãŸãŒã€å›½éš›çš„ãªæ‰¹åˆ¤ã‚’æµ´ã³ã€åŠ´åƒè€…ã®å®šç€ç‡ã‚‚ä½ã„ã§ã™ã€‚",
                        tweet: { user: "ä¸­å°ä¼æ¥­ã‚ªãƒ¤ã‚¸ @sme_boss", content: "æŠ€èƒ½å®Ÿç¿’ç”Ÿé ¼ã¿ã§ã„ã„ã®ã‹ï¼Ÿå½¼ã‚‰ã‚‚æœ€è¿‘ã¯è³ƒé‡‘ã®é«˜ã„ä»–ã®å›½ã«è¡Œã£ã¡ã‚ƒã†ã‚ˆã€‚æ ¹æœ¬çš„ãªè§£æ±ºã«ãªã£ã¦ãªã„ã€‚ #äººæ‰‹ä¸è¶³ #å¤–å›½äººåŠ´åƒè€…" },
                        effect: (s) => ({ gdp: s.gdp + 10, debt: s.debt - 5, approval: s.approval - 5, history: [...s.history, "5å¹´ç›®ï¼šçŸ­æœŸçš„ãªå¤–å›½äººåŠ´åƒåŠ›ã«ä¾å­˜ã€‚"] })
                    },
                    {
                        type: "å³æ´¾ (å°é–)",
                        text: "å˜ä¸€æ°‘æ—ç¶­æŒã€AIè‡ªå‹•åŒ–ã¸å…¨åŠ›æŠ•è³‡",
                        impact: "æ²»å®‰ã¯è‰¯ã„ã§ã™ãŒã€äººæ‰‹ä¸è¶³ã§ä¸­å°ä¼æ¥­ã®å€’ç”£ãŒç›¸æ¬¡ã„ã§ã„ã¾ã™ã€‚",
                        tweet: { user: "æŠ€è¡“ç«‹å›½æ—¥æœ¬ @tech_japan", content: "ç§»æ°‘ã«é ¼ã‚‹ãªï¼ãƒ­ãƒœãƒƒãƒˆã¨AIã§ä¹—ã‚Šåˆ‡ã‚‹ãï¼ã“ã‚Œã“ããŒæ—¥æœ¬æµã®ç”Ÿãæ®‹ã‚Šæ–¹ã ğŸ‡¯ğŸ‡µ #è‡ªå‹•åŒ– #AI" },
                        effect: (s) => ({ gdp: s.gdp - 10, debt: s.debt + 20, approval: s.approval + 10, history: [...s.history, "5å¹´ç›®ï¼šç§»æ°‘æ‹’å¦ã€è‡ªå‹•åŒ–ã¸æŠ•è³‡ã€‚"] })
                    }
                ]
            }
        ];

        // --- State Management ---
        let gameState = { ...INITIAL_STATE };
        let selectedMetric = 'debt'; // debt, gdp, interestRate, approval
        let currentChoiceImpact = "";
        let currentAnalysis = []; // Stores the breakdown
        let currentChoiceTweet = null;
        let lostHp = 0; // HP lost in current turn

        // --- Core Functions ---

        function init() {
            lucide.createIcons();
            renderHp();
            renderDashboard();
            renderGameArea();
            renderChart();
        }

        function renderHp() {
            const hpContainer = document.getElementById('hp-bar');
            const hpText = document.getElementById('hp-text');
            hpContainer.innerHTML = '';
            
            // Render Hearts
            for (let i = 0; i < 8; i++) {
                const isFull = i < gameState.hp;
                const heart = document.createElement('div');
                heart.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${isFull ? '#ef4444' : '#334155'}" stroke="${isFull ? '#ef4444' : '#475569'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-heart"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
                hpContainer.appendChild(heart);
            }
            hpText.innerText = `${gameState.hp} / 8`;
            
            if (gameState.hp <= 2) {
                hpText.classList.add('text-red-400', 'animate-pulse');
                hpText.classList.remove('text-white');
            } else {
                hpText.classList.remove('text-red-400', 'animate-pulse');
                hpText.classList.add('text-white');
            }
        }

        function selectMetric(metric) {
            selectedMetric = metric;
            
            // Update UI styles
            ['debt', 'gdp', 'interestRate', 'approval'].forEach(m => {
                const el = document.getElementById(`card-${m}`);
                const indicator = document.getElementById(`indicator-${m}`);
                
                if (m === metric) {
                    el.classList.add('ring-2', 'ring-offset-1', 'ring-blue-500', 'shadow-md');
                    el.classList.remove('hover:shadow-sm', 'hover:border-blue-200');
                    indicator.classList.remove('hidden');
                } else {
                    el.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-500', 'shadow-md');
                    el.classList.add('hover:shadow-sm', 'hover:border-blue-200');
                    indicator.classList.add('hidden');
                }
            });
            
            renderChart();
        }

        function renderDashboard() {
            // Update Turn
            const turnText = gameState.turn > 5 ? 5 : gameState.turn + 1;
            document.getElementById('turn-display').innerText = `ä»»æœŸ ${turnText} å¹´ç›® / å…¨ 5 å¹´`;

            // Update Metrics
            const debtRatio = gameState.gdp > 0 ? ((gameState.debt / gameState.gdp) * 100).toFixed(1) : "---";
            
            updateCard('debt', `${gameState.debt.toFixed(0)}å…†å††`, `å¯¾GDPæ¯” ${debtRatio}%`, gameState.debt > 1400);
            updateCard('gdp', `${gameState.gdp.toFixed(0)}å…†å††`, `çµŒæ¸ˆè¦æ¨¡`, gameState.gdp < 550);
            updateCard('interestRate', `${gameState.interestRate.toFixed(1)}%`, `åˆ©æ‰•ã„è² æ‹…`, gameState.interestRate > 2.0);
            updateCard('approval', `${gameState.approval.toFixed(0)}%`, `æ”¿æ²»çš„åŸºç›¤`, gameState.approval < 30);
        }

        function updateCard(id, val, sub, isBad) {
            const valEl = document.getElementById(`val-${id}`);
            valEl.innerText = val;
            valEl.className = `text-3xl font-bold ${isBad ? 'text-red-700' : 'text-slate-800'}`;
            document.getElementById(`sub-${id}`).innerText = sub;
            
            const cardEl = document.getElementById(`card-${id}`);
            if (isBad) {
                cardEl.classList.add('bg-red-50', 'border-red-200');
                cardEl.classList.remove('bg-white', 'border-slate-100');
            } else {
                cardEl.classList.add('bg-white', 'border-slate-100');
                cardEl.classList.remove('bg-red-50', 'border-red-200');
            }
        }

        function renderGameArea() {
            const area = document.getElementById('game-area');
            area.innerHTML = '';

            // 0. Start Screen
            if (gameState.turn === 0 && !gameState.gameOver) {
                area.innerHTML = `
                    <div class="text-center space-y-6 max-w-lg mx-auto">
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 text-left">
                            <p class="font-bold text-red-800">è²¡å‹™çœå ±å‘Šï¼š</p>
                            <p class="text-red-700 text-sm mt-1">ç·ç†ã€æˆ‘ãŒå›½ã®å‚µå‹™è¦æ¨¡ã¯å±é™ºæ°´åŸŸã«é”ã—ã¦ã„ã¾ã™ã€‚æ”¹é©ã‚’è¡Œã‚ãªã‘ã‚Œã°ã€æ•°å¹´ä»¥å†…ã«åˆ©æ‰•ã„è²»ãŒäºˆç®—ã‚’é£Ÿã„å°½ãã™ã§ã—ã‚‡ã†ã€‚ã—ã‹ã—ã€ã©ã®æ”¹é©ã‚‚æœ‰æ¨©è€…ã®åç™ºã‚’æ‹›ãã‹ã€çµŒæ¸ˆã‚’æ®ºã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                            <p class="text-slate-600 text-sm mt-3 font-bold">ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ï¼šã‚ãªãŸã¯8ãƒã‚¤ãƒ³ãƒˆã®æ”¿æ²»çš„è³‡æœ¬ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã„ãšã‚Œã‹ã®æŒ‡æ¨™ï¼ˆå›½å‚µã€GDPã€é‡‘åˆ©ã€æ”¯æŒç‡ï¼‰ãŒæ‚ªåŒ–ã™ã‚‹ãŸã³ã«1ãƒã‚¤ãƒ³ãƒˆå¤±ã„ã¾ã™ã€‚ã‚¼ãƒ­ã«ãªã‚‹ã¨å†…é–£ç·è¾è·ã¨ãªã‚Šã¾ã™ã€‚</p>
                        </div>
                        <button onclick="startGame()" class="bg-slate-900 hover:bg-slate-800 text-white px-8 py-3 rounded-lg font-bold transition-all w-full md:w-auto shadow-lg">
                            å°±ä»»å®£èª“ãƒ»æ”¿ç­–æ±ºå®šã‚’é–‹å§‹
                        </button>
                    </div>
                `;
                return;
            }

            // Game Over Screen
            if (gameState.gameOver) {
                const endingColors = {
                    'bankruptcy': 'text-red-600',
                    'growth': 'text-green-600',
                    'neutral': 'text-slate-700',
                    'inflation': 'text-orange-600',
                    'early_election': 'text-purple-600'
                };
                const finalRatio = ((gameState.debt / gameState.gdp) * 100).toFixed(1);

                area.innerHTML = `
                    <div class="space-y-6 text-center animate-fade-in max-w-lg mx-auto">
                        <h2 class="text-3xl font-black ${endingColors[gameState.endingType]}">
                            ${getEndingTitle(gameState.endingType)}
                        </h2>
                        
                        <div class="bg-slate-50 p-6 rounded-lg text-left space-y-4 border border-slate-200">
                            <p class="text-lg font-medium leading-relaxed">${gameState.message}</p>
                            <div class="border-t border-slate-200 pt-4">
                                <h4 class="font-bold text-sm text-slate-400 mb-2">æ”¿æ¨©é‹å–¶ã®è»Œè·¡ï¼š</h4>
                                <ul class="text-sm space-y-1 text-slate-600">
                                    ${gameState.history.map(h => `<li>â€¢ ${h}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-slate-100 p-2 rounded font-mono">æœ€çµ‚å‚µå‹™æ¯”ç‡ï¼š${finalRatio}%</div>
                            <div class="bg-slate-100 p-2 rounded font-mono">æœ€çµ‚é‡‘åˆ©ï¼š${gameState.interestRate.toFixed(1)}%</div>
                        </div>

                        <button onclick="restartGame()" class="bg-slate-900 hover:bg-slate-800 text-white px-8 py-3 rounded-lg font-bold transition-all shadow-lg">
                            ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹
                        </button>
                    </div>
                `;
                return;
            }

            // Scenario Screen
            if (currentChoiceImpact) {
                // Showing Result with Detailed Breakdown
                const breakdownHtml = currentAnalysis.map(item => `
                    <div class="flex justify-between items-center text-sm border-b border-slate-100 py-1 last:border-0">
                        <span class="text-slate-500">${item.label}</span>
                        <div class="flex items-center gap-2">
                            <span class="${item.change > 0 ? (item.isBad ? 'text-red-600' : 'text-green-600') : item.change < 0 ? (item.isBad ? 'text-red-600' : 'text-green-600') : 'text-slate-400'} font-mono">
                                ${item.change > 0 ? '+' : ''}${item.change}${item.unit}
                            </span>
                            ${item.isBad ? '<span class="text-xs bg-red-100 text-red-700 px-1 rounded">-1 pt</span>' : ''}
                        </div>
                    </div>
                `).join('');

                area.innerHTML = `
                    <div class="space-y-6 text-center max-w-lg mx-auto">
                        <div class="inline-flex items-center justify-center p-3 bg-green-100 text-green-700 rounded-full mb-2 animate-bounce">
                            <i data-lucide="arrow-right" class="h-6 w-6"></i>
                        </div>
                        
                        <!-- HP Loss Notification -->
                        ${lostHp > 0 ? 
                            `<div class="bg-red-50 border border-red-200 text-red-800 px-4 py-2 rounded-lg font-bold animate-pulse">
                                âš ï¸ è­¦å‘Šï¼šæŒ‡æ¨™ãŒæ‚ªåŒ–ã—ã€æ”¿æ²»çš„è³‡æœ¬ã‚’ ${lostHp} ãƒã‚¤ãƒ³ãƒˆå¤±ã„ã¾ã—ãŸï¼
                             </div>` : 
                            `<div class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg font-bold">
                                âœ… æ”¿æ²»æƒ…å‹¢ã¯å®‰å®šã—ã¦ã„ã¾ã™
                             </div>`
                        }

                        <div class="text-left bg-white border border-slate-200 rounded-xl p-4 shadow-sm space-y-3">
                            <h4 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="h-4 w-4 text-blue-500"></i> è©³ç´°å½±éŸ¿åˆ†æ
                            </h4>
                            <div class="space-y-1">
                                ${breakdownHtml}
                            </div>
                        </div>

                        <!-- Simulated Tweet -->
                        <div class="text-left mt-2 bg-slate-50 border border-slate-200 rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">
                                    ${currentChoiceTweet.user.charAt(0)}
                                </div>
                                <div class="text-sm">
                                    <span class="font-bold text-slate-900">${currentChoiceTweet.user.split('@')[0]}</span>
                                    <span class="text-slate-400 text-xs">${currentChoiceTweet.user.includes('@') ? '@' + currentChoiceTweet.user.split('@')[1] : ''}</span>
                                </div>
                                <i data-lucide="twitter" class="h-3 w-3 text-blue-400 ml-auto"></i>
                            </div>
                            <p class="text-sm text-slate-700 leading-snug">
                                ${currentChoiceTweet.content}
                            </p>
                        </div>

                        <button onclick="nextTurn()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold w-full shadow-md transition-colors">
                            ç¿Œå¹´åº¦ã¸é€²ã‚€
                        </button>
                    </div>
                `;
                lucide.createIcons();
            } else {
                // Showing Choices (No Changes Here)
                const scenario = SCENARIOS[gameState.turn - 1];
                area.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center gap-2 text-red-600 font-bold uppercase tracking-wider text-sm">
                            <i data-lucide="alert-triangle" class="h-4 w-4"></i> å±æ©Ÿçš„æ±ºæ–­ #${gameState.turn}
                        </div>
                        
                        <h2 class="text-2xl font-bold text-slate-900">
                            ${scenario.title}
                        </h2>
                        
                        <p class="text-slate-600 leading-relaxed">
                            ${scenario.description}
                        </p>

                        <div class="bg-blue-50 text-blue-800 px-4 py-2 rounded text-sm font-medium inline-block mb-2">
                            é‡è¦ãƒ‡ãƒ¼ã‚¿ï¼š${scenario.statContext}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                            ${scenario.choices.map((choice, idx) => {
                                const styles = idx === 0 ? 'bg-red-50 border-red-200 hover:border-red-500 hover:bg-red-100' : 
                                               idx === 1 ? 'bg-slate-50 border-slate-200 hover:border-slate-500 hover:bg-slate-100' : 
                                               'bg-blue-50 border-blue-200 hover:border-blue-500 hover:bg-blue-100';
                                const badge = idx === 0 ? 'bg-red-200 text-red-800' : 
                                              idx === 1 ? 'bg-slate-200 text-slate-800' : 
                                              'bg-blue-200 text-blue-800';
                                
                                return `
                                <button onclick="handleChoice(${idx})" class="group relative flex flex-col items-start p-4 border-2 rounded-xl transition-all hover:shadow-lg text-left h-full ${styles}">
                                    <div class="text-xs font-black uppercase mb-1 px-2 py-0.5 rounded ${badge}">
                                        ${choice.type}
                                    </div>
                                    <span class="font-bold text-base mb-2 leading-tight text-slate-800">${choice.text}</span>
                                    <span class="mt-auto text-xs text-slate-500 pt-2 border-t border-slate-200/50 w-full">
                                       å®Ÿè¡Œã™ã‚‹
                                    </span>
                                </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // --- Game Logic ---

        function startGame() {
            gameState.turn = 1;
            renderHp();
            renderDashboard();
            renderGameArea();
        }

        function handleChoice(choiceIdx) {
            const scenario = SCENARIOS[gameState.turn - 1];
            const choice = scenario.choices[choiceIdx];
            
            // Store previous state for comparison
            const prev = {
                debt: gameState.debt,
                gdp: gameState.gdp,
                interestRate: gameState.interestRate,
                approval: gameState.approval
            };

            // Apply effects
            const changes = choice.effect(gameState);
            
            // Interest Compound Logic
            const interestBurden = (gameState.debt * gameState.interestRate * 0.01) * 2; 
            const newDebt = (changes.debt || gameState.debt) + interestBurden;

            // Update State
            gameState = {
                ...gameState,
                ...changes,
                debt: newDebt
            };

            // Calculate Deltas and HP Loss
            const deltas = {
                debt: gameState.debt - prev.debt,
                gdp: gameState.gdp - prev.gdp,
                interestRate: gameState.interestRate - prev.interestRate,
                approval: gameState.approval - prev.approval
            };

            // Determine if metrics deteriorated (Bad is >0 for debt/rate, <0 for gdp/approval)
            // Rounding to avoid floating point floating precision issues causing false flags on 0 change
            const isBad = {
                debt: deltas.debt > 0.1,
                gdp: deltas.gdp < -0.1,
                interestRate: deltas.interestRate > 0.01,
                approval: deltas.approval < -0.1
            };

            // Calculate damage
            let damage = 0;
            if (isBad.debt) damage++;
            if (isBad.gdp) damage++;
            if (isBad.interestRate) damage++;
            if (isBad.approval) damage++;

            gameState.hp -= damage;
            lostHp = damage;

            // Build Analysis Data
            currentAnalysis = [
                { label: 'å›½å‚µæ®‹é«˜', change: parseFloat(deltas.debt.toFixed(1)), unit: 'å…†å††', isBad: isBad.debt },
                { label: 'åç›® GDP', change: parseFloat(deltas.gdp.toFixed(1)), unit: 'å…†å††', isBad: isBad.gdp },
                { label: 'å›½å‚µé‡‘åˆ©', change: parseFloat(deltas.interestRate.toFixed(2)), unit: '%', isBad: isBad.interestRate },
                { label: 'å†…é–£æ”¯æŒç‡', change: parseFloat(deltas.approval.toFixed(1)), unit: '%', isBad: isBad.approval }
            ];

            // Record History
            const nextTurn = gameState.turn + 1;
            gameState.metricsHistory.push({
                turn: nextTurn,
                debt: gameState.debt,
                gdp: gameState.gdp,
                interestRate: gameState.interestRate,
                approval: gameState.approval
            });

            currentChoiceImpact = choice.impact;
            currentChoiceTweet = choice.tweet;

            // Check for Early Game Over
            if (gameState.hp <= 0) {
                gameState.gameOver = true;
                gameState.endingType = 'early_election';
                gameState.message = "ã€å†…é–£ç·è¾è·ã€‘æ”¯æŒç‡ã®ä½è¿·ã¨çµŒæ¸ˆæŒ‡æ¨™ã®æ‚ªåŒ–ã«ã‚ˆã‚Šã€ã‚ãªãŸã®æ”¿æ²»çš„è³‡æœ¬ã¯å°½ãã¾ã—ãŸã€‚ä¸å…šå†…ã‹ã‚‰é€€é™£ã‚’æ±‚ã‚ã‚‹å£°ãŒä¸ŠãŒã‚Šã€ã‚ãªãŸã¯è§£æ•£ç·é¸æŒ™ã«è¿½ã„è¾¼ã¾ã‚Œã¾ã—ãŸã€‚";
            }

            renderHp();
            renderDashboard();
            renderGameArea();
            renderChart();
        }

        function nextTurn() {
            if (gameState.gameOver) {
                renderGameArea(); // Refresh to show Game Over screen
                return;
            }

            gameState.turn += 1;
            currentChoiceImpact = "";
            currentChoiceTweet = null;
            
            if (gameState.turn > 5) {
                determineEnding();
            }
            
            renderDashboard();
            renderGameArea();
        }

        function determineEnding() {
            const finalRatio = (gameState.debt / gameState.gdp) * 100;
            gameState.gameOver = true;

            // Priority: Bankruptcy -> Capital Depleted (handled in handleChoice) -> Growth -> Neutral -> Inflation
            if (gameState.debt > 1600 || gameState.interestRate > 3.5) {
                gameState.endingType = 'bankruptcy';
                gameState.message = "ã€å›½å®¶ç ´ç”£ã€‘åˆ©æ‰•ã„è²»ãŒç¨åã‚’è¶…ãˆã€æ—¥æœ¬å›½å‚µã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã—ã¾ã—ãŸã€‚å††ã¯ç´™ããšã¨ãªã‚Šã€IMFãŒè²¡æ”¿ã‚’ç®¡ç†ä¸‹ã«ç½®ãã¾ã—ãŸã€‚ã‚ãªãŸã¯æ­´å²çš„ãªæ±šåã‚’æ®‹ã™ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚";
            } else if (finalRatio < 240 && gameState.gdp > 600) {
                gameState.endingType = 'growth';
                gameState.message = "ã€å¥‡è·¡ã®å¾©èˆˆã€‘ç—›ã¿ã‚’ä¼´ã†æ”¹é©ã¨æˆé•·æˆ¦ç•¥ã«ã‚ˆã‚Šã€ã‚ãªãŸã¯å‚µå‹™æ¯”ç‡ã®åˆ¶å¾¡ã«æˆåŠŸã—ã¾ã—ãŸã€‚æ”¯æŒç‡ã¯é«˜ãã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚ãªãŸã¯æ—¥æœ¬ã®æœªæ¥ã‚’æ•‘ã„ã¾ã—ãŸã€‚";
            } else if (gameState.approval < 15) {
                gameState.endingType = 'neutral';
                gameState.message = "ã€å†…é–£ç·è¾è·ã€‘è²¡æ”¿ã¯ç¶­æŒã—ã¾ã—ãŸãŒã€ã‚ãªãŸã®æ”¿ç­–ã¯å›½æ°‘ã®æ€’ã‚Šã‚’è²·ã„ã¾ã—ãŸã€‚ä»»æœŸæº€äº†ã‚’å¾…ãŸãšã«é€€é™£ã‚’è¿«ã‚‰ã‚Œã€å•é¡Œã¯æ¬¡æœŸæ”¿æ¨©ã«æŒã¡è¶Šã•ã‚Œã¾ã—ãŸã€‚";
            } else {
                gameState.endingType = 'inflation';
                gameState.message = "ã€èŒ¹ã§ã‚¬ã‚¨ãƒ«ã€‘ã‚ãªãŸã®æŒ‡å°ã®ä¸‹ã€æ—¥æœ¬ã¯ç¾çŠ¶ç¶­æŒã‚’ç¶šã‘ã¾ã—ãŸã€‚å‚µå‹™ã¯ç©ã¿ä¸ŠãŒã‚Šã€ç·©ã‚„ã‹ãªè¡°é€€ãŒç¶šã„ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯é™ã‹ãªã‚‹é»„æ˜ã§ã™ã€‚";
            }
        }

        function getEndingTitle(type) {
            switch(type) {
                case 'bankruptcy': return 'GAME OVER: å›½å®¶ç ´ç”£';
                case 'growth': return 'VICTORY: è²¡æ”¿å†å»ºæˆåŠŸ';
                case 'neutral': return 'çµå±€ï¼šå†…é–£ç·è¾è·';
                case 'early_election': return 'GAME OVER: ä¿¡é ¼å¤±å¢œ';
                default: return 'çµå±€ï¼šæœªæ¥ã¸ã®éœ§';
            }
        }

        function restartGame() {
            gameState = { ...INITIAL_STATE, metricsHistory: [{ turn: 0, debt: 1286, gdp: 595, interestRate: 0.9, approval: 45 }] };
            currentChoiceImpact = "";
            currentChoiceTweet = null;
            startGame();
        }

        // --- Chart Logic (SVG) ---
        function renderChart() {
            const container = document.getElementById('chart-container');
            const data = gameState.metricsHistory;
            const dataKey = selectedMetric;
            
            // Config
            const labels = {
                'debt': { color: '#ef4444', name: 'å›½å‚µ' },
                'gdp': { color: '#3b82f6', name: 'GDP' },
                'interestRate': { color: '#f97316', name: 'é‡‘åˆ©' },
                'approval': { color: '#22c55e', name: 'æ”¯æŒç‡' }
            };
            const config = labels[dataKey];
            
            // Update Label text
            const firstVal = data[0][dataKey];
            const lastVal = data[data.length-1][dataKey];
            document.getElementById('chart-label').innerText = `${config.name}: ${firstVal.toFixed(1)} â†’ ${lastVal.toFixed(1)}`;

            // Calculate Scales
            const values = data.map(d => d[dataKey]);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1; 
            
            const width = 100;
            const height = 50;
            const padding = 5;

            // Generate Points
            const points = data.map((d, i) => {
                const x = (i / 5) * (width - padding * 2) + padding; 
                const y = height - padding - ((d[dataKey] - min) / range) * (height - padding * 2);
                return `${x},${y}`;
            }).join(' ');

            // Generate Dots
            const dots = data.map((d, i) => {
                const x = (i / 5) * (width - padding * 2) + padding;
                const y = height - padding - ((d[dataKey] - min) / range) * (height - padding * 2);
                return `<circle cx="${x}" cy="${y}" r="1.5" fill="white" stroke="${config.color}" stroke-width="1" />`;
            }).join('');

            // SVG Template
            const svg = `
                <svg viewBox="0 0 ${width} ${height}" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                    <line x1="${padding}" y1="${padding}" x2="${width-padding}" y2="${padding}" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="2" />
                    <line x1="${padding}" y1="${height-padding}" x2="${width-padding}" y2="${height-padding}" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="2" />
                    
                    <polyline
                        fill="none"
                        stroke="${config.color}"
                        stroke-width="2"
                        points="${points}"
                        vector-effect="non-scaling-stroke" 
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                    ${dots}
                </svg>
                <div class="flex justify-between text-[10px] text-slate-400 mt-1 px-1 font-mono">
                    <span>é–‹å§‹</span>
                    <span>1å¹´</span>
                    <span>2å¹´</span>
                    <span>3å¹´</span>
                    <span>4å¹´</span>
                    <span>çµ‚äº†</span>
                </div>
            `;
            
            container.innerHTML = svg;
        }

        // Initialize
        init();

    </script>
</body>
</html>
